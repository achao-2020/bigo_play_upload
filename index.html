<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>é£ä¹¦å¤šç»´è¡¨æ ¼ä¸Šä¼ </title>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 1200px; margin: auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .logout-btn { padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .logout-btn:hover { background: #c82333; }
    .table-box { max-height: 400px; overflow: auto; border: 1px solid #ccc; }
    table { border-collapse: collapse; width: 100%; min-width: 900px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #f5f5f5; position: sticky; top: 0; }
    button { margin-top: 16px; padding: 10px 24px; }
  </style>
  <!-- å¼•å…¥JSZipåº“ -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <!-- åç«¯åœ°å€é…ç½®
       æœ¬åœ°å¼€å‘ï¼ˆä½¿ç”¨ node server.js åŒæ—¶æä¾›å‰ç«¯å’Œåç«¯ï¼‰æ—¶ï¼Œå¯ä»¥ä¿æŒä¸ºç©ºå­—ç¬¦ä¸²ã€‚
       éƒ¨ç½²åˆ°çº¿ä¸Šåï¼ˆå‰ç«¯åœ¨ Cloudflare Pagesï¼Œåç«¯åœ¨ Render/Railway ç­‰ï¼‰ï¼Œ
       è¯·å°†ä¸‹é¢çš„å€¼æ”¹æˆä½ çš„åç«¯åœ°å€ï¼Œä¾‹å¦‚ï¼š
       window.FEISHU_BACKEND_BASE_URL = 'https://your-backend.onrender.com';
  -->
  <script>
    window.FEISHU_BACKEND_BASE_URL = window.FEISHU_BACKEND_BASE_URL || '';
  </script>
</head>
<body>

<div class="header">
  <h2>ä¸Šä¼ æ¯”èµ› JSON</h2>
  <div style="display: flex; gap: 12px; align-items: center;">
    <a href="dashboard.html" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 6px; font-weight: 500; transition: transform 0.2s, box-shadow 0.2s; display: inline-block;" 
       onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'"
       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
      ğŸ“Š BIGOç¯®çƒæŠ€æœ¯ç»Ÿè®¡ä»ªè¡¨ç›˜å…¥å£
    </a>
    <button class="logout-btn" id="logoutBtn">ç™»å‡º</button>
  </div>
</div>
<input type="file" id="fileInput" accept=".json" />
<!-- è‡ªå®šä¹‰æ–‡ä»¶ä¸Šä¼ æŒ‰é’® -->
<div style="display: inline-block; position: relative; margin-left: 20px;">
  <input type="file" id="batchFileInput" accept=".zip,.rar" style="opacity: 0; position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer;" />
  <button style="padding: 5px 10px; cursor: pointer;">ä¸Šä¼ å‹ç¼©æ–‡ä»¶</button>
</div>
<button id="batchUploadBtn">æ‰¹é‡ä¸Šä¼ </button>

<!-- è¿›åº¦æ¡ -->
<div id="progressContainer" style="margin-top: 10px; display: none;">
  <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
    <span>ä¸Šä¼ è¿›åº¦ï¼š</span>
    <span id="progressText">0/0</span>
  </div>
  <div style="width: 100%; height: 20px; background-color: #f0f0f0; border-radius: 10px; overflow: hidden;">
    <div id="progressBar" style="height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s;"></div>
  </div>
</div>

<div class="table-box" style="margin-top: 20px;">
  <h3 style="text-align: center; margin: 10px 0;">æ¯”èµ›çƒé˜Ÿæ•°æ®</h3>
  <table>
    <thead>
      <tr>
        <th>æ¯”èµ›id</th>
        <th>çƒé˜Ÿ</th>
        <th>å¾—åˆ†</th>
        <th>æ¯”èµ›æ—¶é—´</th>
        <th>æ¯”èµ›ç»“æœ</th>
      </tr>
    </thead>
    <tbody id="teamScoresTbody"></tbody>
  </table>
</div>

<div class="table-box">
  <h3 style="text-align: center; margin: 10px 0;">æ¯”èµ›çƒå‘˜æ•°æ®è¡¨</h3>
  <table>
    <thead>
      <tr>
        <th>æ¯”èµ›id</th>
        <th>çƒé˜Ÿ</th>
        <th>çƒå‘˜å§“å</th>
        <th>çƒè¡£å·ç </th>
        <th>å‡ºåœºæ—¶é—´(s)</th>
        <th>å¾—åˆ†</th>
        <th>çŠ¯è§„æ¬¡æ•°</th>
        <th>æ­£è´Ÿå€¼</th>
        <th>æ¯”èµ›æ—¶é—´</th>
        <th>æ¯”èµ›ç»“æœ</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div class="table-box" style="margin-top: 20px;">
  <h3 style="text-align: center; margin: 10px 0;">æ¯”èµ›æ˜ç»†æ•°æ®</h3>
  <table>
    <thead>
      <tr>
        <th>æ¯”èµ›id</th>
        <th>æ¯”èµ›æ—¶é—´</th>
        <th>å½“å‰èŠ‚</th>
        <th>æ¯”èµ›è¿›è¡Œæ—¶é—´</th>
        <th>ç±»å‹</th>
        <th>çƒé˜Ÿ</th>
        <th>çƒå‘˜</th>
        <th>å·ç </th>
        <th>å¾—åˆ†</th>
        <th>æ“ä½œæ—¶é—´</th>
      </tr>
    </thead>
    <tbody id="detailsTbody"></tbody>
  </table>
</div>

<button id="submitBtn" disabled>æäº¤åˆ°é£ä¹¦</button>
<div id="status"></div>

<script type="module">
  import { parseGameJson, submitToFeishu, parseTeamScores, parseDetails, TABLE_IDS } from './feishu/index.js';
  // JSZipå°†é€šè¿‡å…¨å±€å˜é‡window.JSZipè®¿é—®

  // è·å–åç«¯åœ°å€
  const BACKEND_BASE_URL = window.FEISHU_BACKEND_BASE_URL || '';

  // è·å–ç™»å½• token
  function getAuthToken() {
    return localStorage.getItem('auth_token');
  }

  // æ£€æŸ¥ç™»å½•æ€
  async function checkAuth() {
    const token = getAuthToken();
    if (!token) {
      window.location.href = 'login.html';
      return false;
    }

    try {
      const response = await fetch(`${BACKEND_BASE_URL}/api/auth/check`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'x-auth-token': token
        }
      });

      if (response.ok) {
        const data = await response.json();
        if (data.authenticated) {
          return true;
        }
      }
    } catch (error) {
      console.error('æ£€æŸ¥ç™»å½•æ€å¤±è´¥:', error);
    }

    // token æ— æ•ˆï¼Œæ¸…é™¤å¹¶è·³è½¬
    localStorage.removeItem('auth_token');
    window.location.href = 'login.html';
    return false;
  }

  // ç™»å‡ºåŠŸèƒ½
  async function logout() {
    const token = getAuthToken();
    if (token) {
      try {
        await fetch(`${BACKEND_BASE_URL}/api/auth/logout`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'x-auth-token': token
          }
        });
      } catch (error) {
        console.error('ç™»å‡ºè¯·æ±‚å¤±è´¥:', error);
      }
    }
    
    localStorage.removeItem('auth_token');
    window.location.href = 'login.html';
  }

  // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•æ€
  const isAuthenticated = await checkAuth();
  if (!isAuthenticated) {
    // å¦‚æœæœªç™»å½•ï¼ŒcheckAuth å·²ç»è·³è½¬åˆ°ç™»å½•é¡µï¼Œè¿™é‡Œç›´æ¥è¿”å›
    // ä½†ä¸ºäº†å®‰å…¨ï¼Œæˆ‘ä»¬è¿˜æ˜¯é˜»æ­¢åç»­ä»£ç æ‰§è¡Œ
    throw new Error('æœªç™»å½•');
  }

  // ç™»å‡ºæŒ‰é’®äº‹ä»¶
  document.getElementById('logoutBtn').addEventListener('click', logout);

  const fileInput = document.getElementById('fileInput');
  const batchFileInput = document.getElementById('batchFileInput');
  const batchUploadBtn = document.getElementById('batchUploadBtn');
  const progressContainer = document.getElementById('progressContainer');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const tbody = document.getElementById('tbody');
  const teamScoresTbody = document.getElementById('teamScoresTbody');
  const detailsTbody = document.getElementById('detailsTbody');
  const submitBtn = document.getElementById('submitBtn');
  const status = document.getElementById('status');

  let records = [];
  let teamScoresRecords = [];
  let detailsRecords = [];

  // æ—¶é—´æ ¼å¼åŒ–å‡½æ•°ï¼šå°†æ—¶é—´æˆ³è½¬æ¢ä¸ºYYYY-MM-DD HH:MM:SSæ ¼å¼
  function formatTime(timestamp) {
    const date = new Date(timestamp);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
  }

  // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿å¹¶æ˜¾ç¤ºæç¤º
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
      // åˆ›å»ºæç¤ºå…ƒç´ 
      const toast = document.createElement('div');
      toast.textContent = 'å¤åˆ¶æˆåŠŸï¼';
      toast.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 10px 20px;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        border-radius: 5px;
        z-index: 9999;
        font-size: 14px;
      `;
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(toast);
      
      // 2ç§’åç§»é™¤æç¤º
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 2000);
    }).catch(err => {
      console.error('å¤åˆ¶å¤±è´¥:', err);
    });
  }

  // æ ¼å¼åŒ–æ¯”èµ›idæ˜¾ç¤ºï¼ˆåªæ˜¾ç¤ºå‰10ä¸ªå­—ç¬¦ï¼‰
  function formatMatchId(id) {
    const idStr = String(id);
    return idStr.length > 10 ? idStr.substring(0, 10) + '...' : idStr;
  }

  fileInput.addEventListener('change', async e => {
    const file = e.target.files[0];
    if (!file) return;

    const json = JSON.parse(await file.text());
    records = parseGameJson(json);
    teamScoresRecords = parseTeamScores(json);
    detailsRecords = parseDetails(json);

    // æ¸²æŸ“çƒå‘˜æ•°æ®è¡¨æ ¼
    tbody.innerHTML = '';
    records.forEach(r => {
      const tr = document.createElement('tr');
      Object.entries(r).forEach(([key, value]) => {
        const td = document.createElement('td');
        if (key === "æ¯”èµ›æ—¶é—´") {
          td.textContent = formatTime(value);
        } else if (key === "æ¯”èµ›id") {
          // æ¯”èµ›idç‰¹æ®Šå¤„ç†ï¼šæ˜¾ç¤ºå‰10ä¸ªå­—ç¬¦ï¼Œé¼ æ ‡æ‚¬åœæ˜¾ç¤ºå®Œæ•´idï¼Œç‚¹å‡»å¤åˆ¶
          const idStr = String(value);
          const displayValue = formatMatchId(idStr);
          td.textContent = displayValue;
          td.title = idStr; // é¼ æ ‡æ‚¬åœæ˜¾ç¤ºå®Œæ•´id
          td.style.cursor = 'pointer'; // æ˜¾ç¤ºé¼ æ ‡æŒ‡é’ˆ
          td.style.textDecoration = 'underline'; // æ˜¾ç¤ºä¸‹åˆ’çº¿
          td.style.textDecorationColor = '#999'; // ä¸‹åˆ’çº¿é¢œè‰²
          td.onclick = () => copyToClipboard(idStr); // ç‚¹å‡»å¤åˆ¶
        } else {
          td.textContent = value;
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    // æ¸²æŸ“çƒé˜Ÿæ•°æ®è¡¨æ ¼
    teamScoresTbody.innerHTML = '';
    teamScoresRecords.forEach(r => {
      const tr = document.createElement('tr');
      Object.entries(r).forEach(([key, value]) => {
        const td = document.createElement('td');
        if (key === "æ¯”èµ›æ—¶é—´") {
          td.textContent = formatTime(value);
        } else if (key === "æ¯”èµ›id") {
          // æ¯”èµ›idç‰¹æ®Šå¤„ç†ï¼šæ˜¾ç¤ºå‰10ä¸ªå­—ç¬¦ï¼Œé¼ æ ‡æ‚¬åœæ˜¾ç¤ºå®Œæ•´idï¼Œç‚¹å‡»å¤åˆ¶
          const idStr = String(value);
          const displayValue = formatMatchId(idStr);
          td.textContent = displayValue;
          td.title = idStr; // é¼ æ ‡æ‚¬åœæ˜¾ç¤ºå®Œæ•´id
          td.style.cursor = 'pointer'; // æ˜¾ç¤ºé¼ æ ‡æŒ‡é’ˆ
          td.style.textDecoration = 'underline'; // æ˜¾ç¤ºä¸‹åˆ’çº¿
          td.style.textDecorationColor = '#999'; // ä¸‹åˆ’çº¿é¢œè‰²
          td.onclick = () => copyToClipboard(idStr); // ç‚¹å‡»å¤åˆ¶
        } else {
          td.textContent = value;
        }
        tr.appendChild(td);
      });
      teamScoresTbody.appendChild(tr);
    });

    // æ¸²æŸ“æ¯”èµ›æ˜ç»†æ•°æ®è¡¨æ ¼
    detailsTbody.innerHTML = '';
    detailsRecords.forEach(r => {
      const tr = document.createElement('tr');
      Object.entries(r).forEach(([key, value]) => {
        const td = document.createElement('td');
        if (key === "æ“ä½œæ—¶é—´") {
          td.textContent = formatTime(value);
        } else if (key === "æ¯”èµ›id") {
          // æ¯”èµ›idç‰¹æ®Šå¤„ç†ï¼šæ˜¾ç¤ºå‰10ä¸ªå­—ç¬¦ï¼Œé¼ æ ‡æ‚¬åœæ˜¾ç¤ºå®Œæ•´idï¼Œç‚¹å‡»å¤åˆ¶
          const idStr = String(value);
          const displayValue = formatMatchId(idStr);
          td.textContent = displayValue;
          td.title = idStr; // é¼ æ ‡æ‚¬åœæ˜¾ç¤ºå®Œæ•´id
          td.style.cursor = 'pointer'; // æ˜¾ç¤ºé¼ æ ‡æŒ‡é’ˆ
          td.style.textDecoration = 'underline'; // æ˜¾ç¤ºä¸‹åˆ’çº¿
          td.style.textDecorationColor = '#999'; // ä¸‹åˆ’çº¿é¢œè‰²
          td.onclick = () => copyToClipboard(idStr); // ç‚¹å‡»å¤åˆ¶
        } else {
          td.textContent = value;
        }
        tr.appendChild(td);
      });
      detailsTbody.appendChild(tr);
    });

    submitBtn.disabled = records.length === 0;
  });

  // å¤„ç†å•ä¸ªJSONæ–‡ä»¶
  async function processSingleFile(fileContent) {
    try {
      const json = JSON.parse(fileContent);
      const currentRecords = parseGameJson(json);
      const currentTeamScoresRecords = parseTeamScores(json);
      const currentDetailsRecords = parseDetails(json);
      
      // æäº¤åˆ°é£ä¹¦
      await submitToFeishu(currentRecords, TABLE_IDS.PLAYER);
      await submitToFeishu(currentTeamScoresRecords, TABLE_IDS.TEAM);
      await submitToFeishu(currentDetailsRecords, TABLE_IDS.DETAIL);
      
      return true;
    } catch (e) {
      console.error('å¤„ç†æ–‡ä»¶å¤±è´¥:', e);
      return false;
    }
  }

  // æ‰¹é‡å¤„ç†JSONæ–‡ä»¶ï¼ˆæ¯2ç§’å¤„ç†10ä¸ªï¼‰
  async function batchProcessFiles(files) {
    const totalFiles = files.length;
    let processedFiles = 0;
    
    // æ˜¾ç¤ºè¿›åº¦æ¡
    progressContainer.style.display = 'block';
    progressBar.style.width = '0%';
    progressText.textContent = `${processedFiles}/${totalFiles}`;
    
    // åˆ†æ‰¹æ¬¡å¤„ç†æ–‡ä»¶ï¼Œæ¯æ‰¹10ä¸ªï¼Œé—´éš”2ç§’
    for (let i = 0; i < totalFiles; i += 10) {
      const batch = files.slice(i, i + 10);
      
      // å¹¶è¡Œå¤„ç†å½“å‰æ‰¹æ¬¡çš„æ–‡ä»¶
      const batchResults = await Promise.all(batch.map(file => processSingleFile(file.content)));
      
      // æ›´æ–°å·²å¤„ç†æ–‡ä»¶æ•°é‡
      processedFiles += batch.length;
      
      // æ›´æ–°è¿›åº¦æ¡
      const progressPercentage = Math.round((processedFiles / totalFiles) * 100);
      progressBar.style.width = `${progressPercentage}%`;
      progressText.textContent = `${processedFiles}/${totalFiles}`;
      
      // å¦‚æœä¸æ˜¯æœ€åä¸€æ‰¹ï¼Œç­‰å¾…2ç§’
      if (i + 10 < totalFiles) {
        await new Promise(resolve => setTimeout(resolve, 2000));
      }
    }
    
    // å¤„ç†å®Œæˆåéšè—è¿›åº¦æ¡
    setTimeout(() => {
      progressContainer.style.display = 'none';
      status.textContent = `æ‰¹é‡ä¸Šä¼ å®Œæˆï¼Œå…±å¤„ç† ${totalFiles} ä¸ªæ–‡ä»¶`;
    }, 1000);
  }

  // æ‰¹é‡ä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  batchUploadBtn.onclick = async () => {
    const file = batchFileInput.files[0];
    if (!file) {
      status.textContent = 'è¯·å…ˆé€‰æ‹©å‹ç¼©æ–‡ä»¶';
      return;
    }
    
    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
    if (!file.name.endsWith('.zip')) {
      status.textContent = 'ä»…æ”¯æŒZIPæ ¼å¼çš„å‹ç¼©æ–‡ä»¶';
      return;
    }
    
    status.textContent = 'æ­£åœ¨è§£å‹ç¼©æ–‡ä»¶...';
    
    try {
      // è¯»å–æ–‡ä»¶å†…å®¹
      const fileReader = new FileReader();
      const fileContent = await new Promise((resolve, reject) => {
        fileReader.onload = (e) => resolve(e.target.result);
        fileReader.onerror = (e) => reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥'));
        fileReader.readAsArrayBuffer(file);
      });
      
      // è§£å‹æ–‡ä»¶
      const zip = await window.JSZip.loadAsync(fileContent);
      
      // æ”¶é›†æ‰€æœ‰JSONæ–‡ä»¶
      const jsonFiles = [];
      for (const [fileName, file] of Object.entries(zip.files)) {
        if (fileName.endsWith('.json')) {
          const content = await file.async('text');
          jsonFiles.push({ name: fileName, content: content });
        }
      }
      
      if (jsonFiles.length === 0) {
        status.textContent = 'å‹ç¼©æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°JSONæ–‡ä»¶';
        return;
      }
      
      status.textContent = `æ‰¾åˆ° ${jsonFiles.length} ä¸ªJSONæ–‡ä»¶ï¼Œå¼€å§‹æ‰¹é‡ä¸Šä¼ ...`;
      
      // æ‰¹é‡å¤„ç†æ–‡ä»¶
      await batchProcessFiles(jsonFiles);
      
    } catch (e) {
      // æ›´å‹å¥½çš„é”™è¯¯æç¤º
      if (e.message.includes('Can\'t find end of central directory')) {
        status.textContent = 'æ‰¹é‡ä¸Šä¼ å¤±è´¥ï¼šä¸Šä¼ çš„ä¸æ˜¯æœ‰æ•ˆçš„ZIPæ–‡ä»¶';
      } else {
        status.textContent = 'æ‰¹é‡ä¸Šä¼ å¤±è´¥ï¼š' + e.message;
      }
      console.error('æ‰¹é‡ä¸Šä¼ å¤±è´¥:', e);
    }
  };

  submitBtn.onclick = async () => {
    try {
      status.textContent = 'æäº¤ä¸­...';
      submitBtn.disabled = true;
      
      // åŒæ—¶æäº¤çƒå‘˜æ•°æ®ã€çƒé˜Ÿæ•°æ®å’Œæ˜ç»†æ•°æ®
      // æäº¤çƒå‘˜æ•°æ®åˆ°çƒå‘˜è¡¨æ ¼ï¼ˆä½¿ç”¨é»˜è®¤è¡¨æ ¼IDï¼‰
      const playerResult = await submitToFeishu(records, TABLE_IDS.PLAYER);
      
      // æäº¤çƒé˜Ÿæ•°æ®åˆ°çƒé˜Ÿè¡¨æ ¼
      const teamResult = await submitToFeishu(teamScoresRecords, TABLE_IDS.TEAM);
      
      // æäº¤æ˜ç»†æ•°æ®åˆ°æ˜ç»†è¡¨æ ¼
      const detailResult = await submitToFeishu(detailsRecords, TABLE_IDS.DETAIL);
      
      status.textContent = 'æäº¤æˆåŠŸ âœ…';
    } catch (e) {
      status.textContent = 'æäº¤å¤±è´¥ï¼š' + e.message;
      submitBtn.disabled = false;
    }
  };
</script>

</body>
</html>
